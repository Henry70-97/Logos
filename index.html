<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Creativepay - Creative Writing Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap');
        
        * {
            font-family: 'DM Sans', 'Poppins', sans-serif;
        }
        
        html, body {
            height: 100%;
        }
        
        body {
            background: linear-gradient(135deg, #FFF5F7 0%, #FFF9E6 50%, #F0FFF4 100%);
            position: relative;
            overflow-x: hidden;
        }
        
        /* Floating background shapes */
        body::before,
        body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            opacity: 0.15;
            z-index: 0;
            pointer-events: none;
        }
        
        body::before {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, #FF6B9D 0%, transparent 70%);
            top: -200px;
            right: -200px;
            animation: float 20s ease-in-out infinite;
        }
        
        body::after {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, #4ECDC4 0%, transparent 70%);
            bottom: -150px;
            left: -150px;
            animation: float 25s ease-in-out infinite reverse;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(30px, -30px) scale(1.1); }
        }
        
        .floating-shape {
            position: fixed;
            border-radius: 50%;
            opacity: 0.1;
            z-index: 0;
            pointer-events: none;
        }
        
        .shape-1 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, #A29BFE 0%, transparent 70%);
            top: 20%;
            left: 10%;
            animation: float 15s ease-in-out infinite;
        }
        
        .shape-2 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, #FFD93D 0%, transparent 70%);
            top: 60%;
            right: 15%;
            animation: float 18s ease-in-out infinite reverse;
        }
        
        .fintech-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }
        
        .fintech-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        
        .gradient-card-1 {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .gradient-card-2 {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
        }
        
        .gradient-card-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .gradient-card-4 {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .wallet-balance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 32px;
            color: white;
            box-shadow: 0 20px 60px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .wallet-balance-card::before {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            top: -50px;
            right: -50px;
        }
        
        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            padding: 16px 32px;
            border-radius: 16px;
            font-weight: 600;
            border: 2px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #f093fb, #f5576c, #ff9a56, #4facfe);
            background-size: 200% 100%;
            animation: progressAnimation 2s linear infinite;
        }
        
        @keyframes progressAnimation {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }
        
        .whatsapp-float {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 8px 24px rgba(37, 211, 102, 0.4);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .whatsapp-float:hover {
            transform: scale(1.1);
        }
        
        .hidden {
            display: none;
        }
        
        .task-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        .task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }
        
        .hamburger {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .hamburger span {
            width: 28px;
            height: 3px;
            background: white;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .logo-text {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            font-size: 32px;
            background: linear-gradient(135deg, #FFD93D 0%, #FF6B9D 50%, #4ECDC4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }
        
        .sidebar {
            position: fixed;
            left: -320px;
            top: 0;
            width: 320px;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 4px 0 24px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1001;
            overflow-y: auto;
        }
        
        .sidebar.open {
            left: 0;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-radius: 16px;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #2D3748;
        }
        
        .sidebar-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            transform: translateX(4px);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
        
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
            z-index: 1002;
            display: none;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
        }
        
        .modal.active {
            display: block;
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .review-spinner {
            width: 64px;
            height: 64px;
            border: 6px solid rgba(255,255,255,0.2);
            border-top: 6px solid #FFD93D;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 28px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.16);
            z-index: 9999;
            animation: slideDown 0.3s ease-out;
            backdrop-filter: blur(10px);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border-radius: 16px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .back-button:hover {
            background: white;
            border-color: #667eea;
            transform: translateX(-4px);
        }
        
        .input-field {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.1);
        }
        
        .tag {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .icon-badge {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50 h-full"><!-- Floating shapes -->
  <div class="floating-shape shape-1"></div>
  <div class="floating-shape shape-2"></div>
  <div class="progress-bar"></div><!-- Overlay -->
  <div class="overlay" id="overlay"></div><!-- Sidebar Menu -->
  <div class="sidebar" id="sidebar">
   <div class="p-6">
    <h2 class="text-2xl font-bold mb-6 text-purple-600">Menu</h2>
    <nav class="space-y-4"><a href="#" onclick="event.preventDefault(); showSection('home')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition">ÔøΩÔøΩÔøΩÔøΩ Home</a> <a href="#" onclick="event.preventDefault(); showSection('dashboard')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition">üìä Dashboard</a> <a href="https://appsgeyser.io/19496137/Creativepay" target="_blank" rel="noopener noreferrer" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition bg-gradient-to-r from-blue-100 to-green-100">üì± Download App</a> <a href="#" onclick="event.preventDefault(); showSection('subscription')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition">‚≠ê My Subscription</a> <a href="#" onclick="event.preventDefault(); showSection('available-tasks')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition">üìù Available Tasks</a> <a href="#" onclick="event.preventDefault(); showSection('submitted-tasks')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition">üì§ My Submitted Tasks</a> <a href="#" onclick="event.preventDefault(); showSection('wallet')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition">üí∞ Wallet</a> <a href="#" onclick="event.preventDefault(); showSection('subscription')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition bg-gradient-to-r from-purple-100 to-pink-100">‚¨ÜÔ∏è Upgrade Plan</a> <a href="#" onclick="event.preventDefault(); showSection('withdraw')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition">üí≥ Withdraw</a> <a href="#" onclick="event.preventDefault(); showSection('support')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition">üí¨ Support</a> <a href="#" onclick="event.preventDefault(); showSection('refund')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition">üîÑ Request Refund</a> <a href="#" onclick="event.preventDefault(); showSection('profile')" class="block py-3 px-4 rounded-lg hover:bg-purple-50 transition">‚öôÔ∏è Profile</a> <a href="#" onclick="event.preventDefault(); logout()" class="block py-3 px-4 rounded-lg hover:bg-red-50 text-red-600 transition">üö™ Logout</a>
    </nav>
   </div>
  </div><!-- WhatsApp Float Button -->
  <div class="whatsapp-float" onclick="openWhatsApp()">
   üí¨
  </div><!-- Main Content -->
  <div id="main-content" class="h-full"><!-- Home/Landing Section -->
   <section id="home-section" class="min-h-screen"><!-- Header -->
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-center items-center">
      <div class="text-center">
       <h1 class="text-5xl font-bold mb-2 flame-text">creative writing </h1>
       <div class="rotating-words"><span class="word active">Academic Excellence</span> <span class="word">Quality Writing</span> <span class="word">Earn While You Write</span> <span class="word">Professional Writers</span> <span class="word">Your Success Partner</span>
       </div>
      </div>
     </div>
    </header><!-- Hero Section -->
    <section class="relative overflow-hidden py-24 px-6" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);">
     <div class="max-w-5xl mx-auto text-center relative z-10 animate-fade-in">
      <h2 class="text-6xl md:text-7xl font-black mb-6 text-white leading-tight">Earn from Your<br><span class="bg-gradient-to-r from-yellow-200 via-pink-200 to-green-200 bg-clip-text text-transparent">creative writing Skills</span></h2>
      <p class="text-2xl mb-10 text-white/95 max-w-3xl mx-auto font-medium">Join Kenya's leading creative writing platform.<br>
       Get paid <span class="font-bold text-yellow-300">Ksh 350/page</span> for quality work.</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center items-center mb-12"><button onclick="event.preventDefault(); showSection('register');" class="px-10 py-5 bg-white text-purple-600 rounded-2xl text-xl font-bold hover:bg-yellow-300 hover:text-purple-700 transition-all transform hover:scale-105 shadow-2xl"> üöÄ Start Earning Now </button> <button onclick="event.preventDefault(); showSection('login');" class="px-10 py-5 bg-transparent border-3 border-white text-white rounded-2xl text-xl font-bold hover:bg-white hover:text-purple-600 transition-all transform hover:scale-105"> Sign In </button>
      </div>
     </div>
    </section><!-- Footer -->
    <footer class="bg-gray-800 text-white py-12 px-6">
     <div class="max-w-7xl mx-auto">
      <div class="grid md:grid-cols-3 gap-8 mb-8">
       <div>
        <h3 class="text-xl font-bold mb-4">creative writing </h3>
        <p class="text-gray-400">Professional creative writing platform</p>
       </div>
       <div>
        <h4 class="font-bold mb-4">Quick Links</h4>
        <ul class="space-y-2 text-gray-400">
         <li><a href="#" onclick="event.preventDefault(); showModal('terms')" class="hover:text-white transition">Terms &amp; Conditions</a></li>
         <li><a href="#" onclick="event.preventDefault(); showModal('privacy')" class="hover:text-white transition">Privacy Policy</a></li>
        </ul>
       </div>
       <div>
        <h4 class="font-bold mb-4">Contact</h4>
        <p class="text-gray-400">Email: joblifyafrica@gmail.com/support@creativepay.top</p>
        <p class="text-gray-400">Phone: +254 947 570 62</p>
       </div>
      </div>
      <div class="border-t border-gray-700 pt-6 text-center">
       <p class="text-gray-400">¬© 2024 creative writing . All rights reserved.</p>
      </div>
     </div>
    </footer>
   </section><!-- Registration Section -->
   <section id="register-section" class="min-h-screen bg-gray-50 py-12 px-6 hidden">
    <div class="max-w-2xl mx-auto">
     <div class="mb-6"><button onclick="showSection('home')" class="back-button"> ‚Üê Back to Home </button>
     </div>
     <div class="bg-white rounded-xl shadow-lg p-8 animate-fade-in">
      <h2 class="text-3xl font-bold mb-6 text-center text-purple-600">Writer Registration</h2>
      <form id="registration-form" class="space-y-6">
       <div><label for="reg-email" class="block text-sm font-semibold mb-2">Email Address</label> <input type="email" id="reg-email" class="w-full border border-gray-300 rounded-lg p-3" placeholder="your.email@example.com" required>
       </div>
       <div><label for="reg-phone" class="block text-sm font-semibold mb-2">Phone Number</label> <input type="tel" id="reg-phone" class="w-full border border-gray-300 rounded-lg p-3" placeholder="+254..." required>
       </div>
       <div><label for="reg-fullname" class="block text-sm font-semibold mb-2">Full Name</label> <input type="text" id="reg-fullname" class="w-full border border-gray-300 rounded-lg p-3" placeholder="John Doe" required>
       </div>
       <div><label for="reg-expertise" class="block text-sm font-semibold mb-2">Level of Expertise</label> <select id="reg-expertise" class="w-full border border-gray-300 rounded-lg p-3" required> <option value="">Select Level</option> <option value="beginner">Beginner (0-6 months)</option> <option value="intermediate">Intermediate (6-12 months)</option> <option value="advanced">Advanced (1-2 years)</option> <option value="expert">Expert (2+ years)</option> </select>
       </div>
       <div><label for="reg-password" class="block text-sm font-semibold mb-2">Password</label> <input type="password" id="reg-password" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Create a strong password" required>
       </div><button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-bold hover:from-purple-600 hover:to-pink-600 transition">Register Now</button>
       <p class="text-center text-gray-600">Already have an account? <a href="#" onclick="event.preventDefault(); showSection('login')" class="text-purple-600 hover:underline">Login here</a></p>
      </form>
     </div>
    </div>
   </section><!-- Login Section -->
   <section id="login-section" class="min-h-screen bg-gray-50 py-12 px-6 hidden">
    <div class="max-w-md mx-auto">
     <div class="mb-6"><button onclick="showSection('home')" class="back-button"> ‚Üê Back to Home </button>
     </div>
     <div class="bg-white rounded-xl shadow-lg p-8 animate-fade-in">
      <h2 class="text-3xl font-bold mb-6 text-center text-purple-600">Writer Login</h2>
      <form id="login-form" class="space-y-6">
       <div><label for="login-email" class="block text-sm font-semibold mb-2">Email Address</label> <input type="email" id="login-email" class="w-full border border-gray-300 rounded-lg p-3" placeholder="your.email@example.com" required>
       </div>
       <div><label for="login-password" class="block text-sm font-semibold mb-2">Password</label> <input type="password" id="login-password" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Enter your password" required>
       </div><button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-bold hover:from-purple-600 hover:to-pink-600 transition">Login</button>
       <p class="text-center text-gray-600">Don't have an account? <a href="#" onclick="event.preventDefault(); showSection('register')" class="text-purple-600 hover:underline">Register here</a></p>
      </form>
     </div>
    </div>
   </section><!-- Dashboard Section -->
   <section id="dashboard-section" class="min-h-screen bg-gray-50 hidden">
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4">
       <div class="hamburger" onclick="toggleSidebar()"><span></span> <span></span> <span></span>
       </div>
       <h1 class="text-2xl font-bold">Dashboard</h1>
      </div>
      <div class="flex items-center gap-4"><span id="user-name-display" class="font-semibold"></span>
      </div>
     </div>
    </header>
    <div class="max-w-7xl mx-auto py-8 px-6">
     <div class="grid md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-purple-500">
       <div class="flex justify-between items-center">
        <div>
         <p class="text-gray-600 text-sm">Wallet Balance</p>
         <p class="text-2xl font-bold text-purple-600" id="dashboard-balance">Ksh 0</p>
        </div>
        <div class="text-4xl">
         üí∞
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-pink-500">
       <div class="flex justify-between items-center">
        <div>
         <p class="text-gray-600 text-sm">Tasks In Progress</p>
         <p class="text-2xl font-bold text-pink-600" id="tasks-in-progress">0</p>
        </div>
        <div class="text-4xl">
         üìù
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-green-500">
       <div class="flex justify-between items-center">
        <div>
         <p class="text-gray-600 text-sm">Tasks Approved</p>
         <p class="text-2xl font-bold text-green-600" id="tasks-approved">0</p>
        </div>
        <div class="text-4xl">
         ‚úÖ
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-orange-500">
       <div class="flex justify-between items-center">
        <div>
         <p class="text-gray-600 text-sm">Total Earnings</p>
         <p class="text-xl font-bold text-orange-600" id="total-earnings">Ksh 0</p>
        </div>
        <div class="text-4xl">
         üíµ
        </div>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl shadow-md p-6 mb-6" id="welcome-bonus-card">
      <h3 class="text-xl font-bold mb-4">üéâ Welcome to creative writing !</h3>
      <p class="text-gray-600 mb-4">Start earning by accepting writing tasks. Browse available tasks and submit quality work to get paid.</p><button onclick="showSection('available-tasks')" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-lg font-bold hover:from-purple-600 hover:to-pink-600 transition"> Browse Available Tasks </button>
     </div>
     <div class="bg-gradient-to-r from-yellow-400 via-orange-400 to-pink-400 rounded-xl shadow-lg p-8 text-white" id="bonus-claim-card">
      <div class="text-center">
       <div class="text-6xl mb-4">
        üéÅ
       </div>
       <h3 class="text-3xl font-bold mb-3">Welcome Bonus!</h3>
       <p class="text-lg mb-6 opacity-90">Claim your free welcome bonus now and start your earning journey!</p><button onclick="claimWelcomeBonus()" id="claim-bonus-btn" class="bg-white text-orange-600 px-8 py-4 rounded-xl font-bold text-xl hover:bg-gray-100 transition transform hover:scale-105 shadow-lg"> üí∞ Claim Bonus Now! </button>
      </div>
     </div>
    </div>
   </section><!-- Available Tasks Section -->
   <section id="available-tasks-section" class="min-h-screen bg-gray-50 hidden">
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4"><button onclick="showSection('dashboard')" class="back-button"> ‚Üê Back </button>
       <h1 class="text-2xl font-bold">Available Tasks</h1>
      </div>
     </div>
    </header>
    <div class="max-w-7xl mx-auto py-8 px-6">
     <div id="no-subscription-alert" class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg mb-6 hidden">
      <div class="flex items-start">
       <div class="text-3xl mr-4">
        ‚ö†Ô∏è
       </div>
       <div>
        <h3 class="text-lg font-bold text-yellow-800 mb-2">Payment Pending</h3>
        <p class="text-yellow-700 mb-4">You can view all tasks, but you need to activate your subscription to accept and submit work.</p><button onclick="showSection('payment')" class="bg-yellow-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition mr-3"> üí≥ Pay Now </button> <button onclick="showSection('subscription')" class="bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-gray-600 transition"> Change Plan </button>
       </div>
      </div>
     </div>
     <div id="tasks-content" class="hidden">
      <div class="bg-white rounded-xl shadow-md p-6 mb-8"><label class="block text-lg font-bold mb-4">Select Subject:</label> <select id="subject-filter" class="w-full border border-gray-300 rounded-lg p-3"> <option value="literature">Literature (Novels &amp; Plays)</option> <option value="essay">Essay Writing</option> <option value="poetry" id="poetry-option">Poetry Analysis</option> </select>
      </div>
      <div id="tasks-grid" class="grid md:grid-cols-2 gap-6"><!-- Tasks will be loaded here -->
      </div>
     </div>
    </div>
   </section><!-- Subscription Section -->
   <section id="subscription-section" class="min-h-screen bg-gray-50 hidden">
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4"><button onclick="showSection('dashboard')" class="back-button"> ‚Üê Back </button>
       <h1 class="text-2xl font-bold">My Subscription</h1>
      </div>
     </div>
    </header>
    <div class="max-w-7xl mx-auto py-8 px-6"><!-- Active Subscription Display -->
     <div id="active-subscription" class="hidden mb-8">
      <div class="bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-xl shadow-lg p-8">
       <div class="flex justify-between items-start">
        <div>
         <h2 class="text-3xl font-bold mb-2">‚úì Active Subscription</h2>
         <p class="text-xl mb-2">Plan: <span id="current-plan-name" class="font-bold"></span></p>
         <p class="text-sm opacity-90">Activated: <span id="subscription-date"></span></p>
        </div>
        <div class="text-5xl">
         ‚≠ê
        </div>
       </div>
      </div>
     </div><!-- Subscription Plans -->
     <div id="subscription-plans">
      <h2 class="text-3xl font-bold text-center mb-8">Choose Your Plan</h2>
      <div class="grid md:grid-cols-2 gap-8"><!-- Basic Plan -->
       <div class="bg-white rounded-xl shadow-lg p-8 border-2 border-gray-200 hover:border-purple-500 transition">
        <div class="text-center mb-6">
         <div class="text-4xl mb-4">
          üìö
         </div>
         <h3 class="text-2xl font-bold mb-2">BASIC</h3>
         <div class="text-4xl font-black text-purple-600 mb-2">
          Ksh 310
         </div>
         <p class="text-gray-600">One-time payment</p>
        </div>
        <div class="space-y-3 mb-6">
         <div class="flex items-start gap-3"><span class="text-green-500 text-xl">‚úì</span>
          <p>Setbook essay tasks only</p>
         </div>
         <div class="flex items-start gap-3"><span class="text-green-500 text-xl">‚úì</span>
          <p>Tasks up to 4 pages</p>
         </div>
         <div class="flex items-start gap-3"><span class="text-green-500 text-xl">‚úì</span>
          <p>Earn Ksh 350 per page</p>
         </div>
         <div class="flex items-start gap-3"><span class="text-yellow-500 text-xl">‚è∞</span>
          <p>Withdrawal: 24-48 hours</p>
         </div>
        </div><button onclick="selectPlan('basic')" class="w-full bg-purple-500 text-white py-3 rounded-lg font-bold hover:bg-purple-600 transition"> Select Basic </button>
       </div><!-- Premium Plan -->
       <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white rounded-xl shadow-2xl p-8 border-2 border-yellow-400 transform hover:scale-105 transition">
        <div class="text-center mb-6">
         <div class="bg-yellow-400 text-purple-800 px-3 py-1 rounded-full text-sm font-bold inline-block mb-3">
          MOST POPULAR
         </div>
         <div class="text-4xl mb-4">
          üëë
         </div>
         <h3 class="text-2xl font-bold mb-2">PREMIUM</h3>
         <div class="text-4xl font-black mb-2">
          Ksh 489
         </div>
         <p class="text-white/90">One-time payment</p>
        </div>
        <div class="space-y-3 mb-6">
         <div class="flex items-start gap-3"><span class="text-yellow-300 text-xl">‚úì</span>
          <p>ALL essay tasks unlimited</p>
         </div>
         <div class="flex items-start gap-3"><span class="text-yellow-300 text-xl">‚úì</span>
          <p>Poetry tasks included</p>
         </div>
         <div class="flex items-start gap-3"><span class="text-yellow-300 text-xl">‚úì</span>
          <p>Unlimited page count</p>
         </div>
         <div class="flex items-start gap-3"><span class="text-yellow-300 text-xl">‚ö°</span>
          <p><strong>INSTANT withdrawals</strong></p>
         </div>
         <div class="flex items-start gap-3"><span class="text-yellow-300 text-xl">‚úì</span>
          <p>Priority task access</p>
         </div>
         <div class="flex items-start gap-3"><span class="text-yellow-300 text-xl">‚úì</span>
          <p>Higher earnings potential</p>
         </div>
        </div><button onclick="selectPlan('premium')" class="w-full bg-yellow-400 text-purple-800 py-3 rounded-lg font-bold hover:bg-yellow-300 transition"> Select Premium </button>
       </div>
      </div>
     </div>
    </div>
   </section><!-- Payment Section -->
   <section id="payment-section" class="min-h-screen bg-gray-50 hidden">
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4"><button onclick="showSection('subscription')" class="back-button"> ‚Üê Back </button>
       <h1 class="text-2xl font-bold">Payment</h1>
      </div>
     </div>
    </header>
    <div class="max-w-3xl mx-auto py-8 px-6">
     <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
      <h2 class="text-2xl font-bold mb-6 text-center">Complete Your Payment</h2>
      <div class="bg-purple-50 p-6 rounded-lg mb-6">
       <div class="flex justify-between items-center mb-2"><span class="font-semibold">Selected Plan:</span> <span id="selected-plan-name" class="text-xl font-bold text-purple-600"></span>
       </div>
       <div class="flex justify-between items-center"><span class="font-semibold">Amount:</span> <span id="selected-plan-price" class="text-2xl font-bold text-green-600"></span>
       </div>
      </div>
      <div class="mb-6"><label class="block text-sm font-semibold mb-2">M-Pesa Phone Number</label> <input type="tel" id="payment-phone" class="w-full border border-gray-300 rounded-lg p-3" placeholder="+254..." value="">
      </div><button onclick="initiateSTKPush()" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-4 rounded-lg font-bold text-lg hover:from-green-600 hover:to-blue-600 transition mb-4"> üí≥ Pay Now - M-Pesa STK Push </button> <button onclick="payLater()" class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition mb-4"> ‚è∞ Pay Later - Browse Tasks </button>
      <div class="border-t pt-6">
       <p class="text-center text-gray-600 mb-4">Already subscribed but not redirecting?</p><button onclick="showManualVerification()" class="text-blue-600 hover:underline font-semibold block text-center w-full mb-3"> Click here to verify manually </button>
       <div id="manual-verification" class="hidden mt-4"><label class="block text-sm font-semibold mb-2">Paste M-Pesa Payment Message:</label> <textarea id="payment-message" rows="4" class="w-full border border-gray-300 rounded-lg p-3 mb-3" placeholder="Paste the M-Pesa confirmation message here..."></textarea> <button onclick="verifyPayment()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition"> Verify &amp; Activate </button>
       </div>
      </div>
     </div>
    </div>
   </section><!-- Submitted Tasks Section -->
   <section id="submitted-tasks-section" class="min-h-screen bg-gray-50 hidden">
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4"><button onclick="showSection('dashboard')" class="back-button"> ‚Üê Back </button>
       <h1 class="text-2xl font-bold">My Submitted Tasks</h1>
      </div>
     </div>
    </header>
    <div class="max-w-7xl mx-auto py-8 px-6">
     <div id="submitted-tasks-list" class="space-y-6">
      <div class="bg-white rounded-xl shadow-md p-6 text-center text-gray-500">
       <p class="text-lg">No submitted tasks yet. Accept a task to get started!</p>
      </div>
     </div>
    </div>
   </section><!-- Wallet Section -->
   <section id="wallet-section" class="min-h-screen bg-gray-50 hidden">
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4"><button onclick="showSection('dashboard')" class="back-button"> ‚Üê Back </button>
       <h1 class="text-2xl font-bold">Wallet &amp; Earnings</h1>
      </div>
     </div>
    </header>
    <div class="max-w-7xl mx-auto py-8 px-6">
     <div class="grid md:grid-cols-2 gap-6 mb-8">
      <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white rounded-xl shadow-lg p-8">
       <p class="text-lg opacity-90 mb-2">Current Balance</p>
       <p class="text-4xl font-bold" id="wallet-balance">Ksh 0</p>
      </div>
      <div class="bg-gradient-to-br from-green-500 to-blue-500 text-white rounded-xl shadow-lg p-8">
       <p class="text-lg opacity-90 mb-2">Total Earnings</p>
       <p class="text-4xl font-bold" id="wallet-total-earnings">Ksh 0</p>
      </div>
     </div>
     <div class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-bold mb-4">Transaction History</h3>
      <div id="transaction-history" class="space-y-3">
       <p class="text-gray-500 text-center py-8">No transactions yet</p>
      </div>
     </div>
    </div>
   </section><!-- Withdraw Section -->
   <section id="withdraw-section" class="min-h-screen bg-gray-50 hidden">
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4"><button onclick="showSection('dashboard')" class="back-button"> ‚Üê Back </button>
       <h1 class="text-2xl font-bold">Withdraw Funds</h1>
      </div>
     </div>
    </header>
    <div class="max-w-3xl mx-auto py-8 px-6">
     <div class="bg-white rounded-xl shadow-md p-8">
      <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
       <p class="font-semibold">üí∞ Withdraw any amount - No minimum required!</p>
      </div>
      <form id="withdrawal-form" class="space-y-6">
       <div><label for="withdrawal-amount" class="block text-sm font-semibold mb-2">Amount (Ksh)</label> <input type="number" id="withdrawal-amount" min="1" step="0.01" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Enter any amount" required>
       </div>
       <div><label for="withdrawal-method" class="block text-sm font-semibold mb-2">Withdrawal Method</label> <select id="withdrawal-method" class="w-full border border-gray-300 rounded-lg p-3" required> <option value="">Select Method</option> <option value="mpesa">M-Pesa</option> <option value="bank">Bank Transfer</option> </select>
       </div>
       <div id="mpesa-details" class="hidden"><label for="mpesa-number" class="block text-sm font-semibold mb-2">M-Pesa Phone Number</label> <input type="tel" id="mpesa-number" class="w-full border border-gray-300 rounded-lg p-3" placeholder="+254...">
       </div><button type="submit" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-3 rounded-lg font-bold hover:from-green-600 hover:to-blue-600 transition"> Request Withdrawal </button>
      </form>
     </div>
    </div>
   </section><!-- Profile Section -->
   <section id="profile-section" class="min-h-screen bg-gray-50 hidden">
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4"><button onclick="showSection('dashboard')" class="back-button"> ‚Üê Back </button>
       <h1 class="text-2xl font-bold">Profile Settings</h1>
      </div>
     </div>
    </header>
    <div class="max-w-3xl mx-auto py-8 px-6">
     <div class="bg-white rounded-xl shadow-md p-8">
      <h2 class="text-2xl font-bold mb-6">My Profile</h2>
      <div id="profile-display" class="space-y-4"><!-- Profile info will be displayed here -->
      </div>
     </div>
    </div>
   </section><!-- Support Section -->
   <section id="support-section" class="min-h-screen bg-gray-50 hidden">
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4"><button onclick="showSection('dashboard')" class="back-button"> ‚Üê Back </button>
       <h1 class="text-2xl font-bold">Support &amp; Help</h1>
      </div>
     </div>
    </header>
    <div class="max-w-3xl mx-auto py-8 px-6">
     <div class="bg-white rounded-xl shadow-md p-8">
      <h2 class="text-2xl font-bold mb-6">Contact Support</h2>
      <form id="support-form" class="space-y-6">
       <div><label for="support-subject" class="block text-sm font-semibold mb-2">Subject</label> <select id="support-subject" class="w-full border border-gray-300 rounded-lg p-3" required> <option value="">Select Subject</option> <option value="Payment Issue">Payment Issue</option> <option value="Withdrawal Problem">Withdrawal Problem</option> <option value="Task Review Question">Task Review Question</option> <option value="Account Issue">Account Issue</option> <option value="Technical Problem">Technical Problem</option> <option value="Other">Other</option> </select>
       </div>
       <div><label for="support-message" class="block text-sm font-semibold mb-2">Your Message</label> <textarea id="support-message" rows="6" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Describe your issue..." required></textarea>
       </div><button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-bold hover:from-purple-600 hover:to-pink-600 transition"> Submit Support Request </button>
      </form>
     </div>
    </div>
   </section><!-- Refund Section -->
   <section id="refund-section" class="min-h-screen bg-gray-50 hidden">
    <header class="gradient-bg text-white py-4 px-6">
     <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-4"><button onclick="showSection('dashboard')" class="back-button"> ‚Üê Back </button>
       <h1 class="text-2xl font-bold">Request Refund</h1>
      </div>
     </div>
    </header>
    <div class="max-w-3xl mx-auto py-8 px-6">
     <div class="bg-white rounded-xl shadow-md p-8">
      <h2 class="text-2xl font-bold mb-6">Refund Request Form</h2>
      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
       <p class="font-semibold text-yellow-800">‚ö†Ô∏è Refund Policy</p>
       <p class="text-sm text-yellow-700 mt-1">Refunds are processed within 3-5 business days for valid requests.</p>
      </div>
      <form id="refund-form" class="space-y-6">
       <div><label for="refund-type" class="block text-sm font-semibold mb-2">Refund Type</label> <select id="refund-type" class="w-full border border-gray-300 rounded-lg p-3" required> <option value="">Select Type</option> <option value="Subscription Payment">Subscription Payment Refund</option> <option value="Duplicate Payment">Duplicate Payment</option> <option value="Service Not Delivered">Service Not Delivered</option> <option value="Other">Other</option> </select>
       </div>
       <div><label for="refund-amount" class="block text-sm font-semibold mb-2">Amount (Ksh)</label> <input type="number" id="refund-amount" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Enter amount" required>
       </div>
       <div><label for="refund-transaction" class="block text-sm font-semibold mb-2">Transaction Reference</label> <input type="text" id="refund-transaction" class="w-full border border-gray-300 rounded-lg p-3" placeholder="M-Pesa transaction code" required>
       </div>
       <div><label for="refund-reason" class="block text-sm font-semibold mb-2">Reason for Refund</label> <textarea id="refund-reason" rows="5" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Explain why you're requesting a refund..." required></textarea>
       </div><button type="submit" class="w-full bg-gradient-to-r from-red-500 to-orange-500 text-white py-3 rounded-lg font-bold hover:from-red-600 hover:to-orange-600 transition"> Submit Refund Request </button>
      </form>
     </div>
    </div>
   </section>
  </div><!-- Modal for Info -->
  <div class="modal" id="info-modal">
   <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold" id="modal-title"></h2><button onclick="closeModal()" class="text-3xl hover:text-gray-600">√ó</button>
   </div>
   <div id="modal-content" class="text-gray-700 leading-relaxed"></div>
  </div><!-- Task Details Modal -->
  <div class="modal" id="task-modal">
   <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold">Task Details</h2><button onclick="closeModal()" class="text-3xl hover:text-gray-600">√ó</button>
   </div>
   <div id="task-modal-content"></div>
  </div>
  <script>
        let currentUser = null;
        let acceptedTask = null;
        let allTasks = [];
        let selectedPlan = null;
        let isReviewing = false;
        let reviewInterval = null;
        let withdrawalCountdown = null;
        
        const WEB3FORMS_KEY = '4d568274-521b-452a-a113-62eed5ad915b';
        const ADMIN_EMAIL = 'joblifyafrica@gmail.com';
        
        async function sendEmailNotification(subject, message, userData = {}) {
            try {
                const formData = new FormData();
                formData.append('access_key', WEB3FORMS_KEY);
                formData.append('subject', `EduScript - ${subject}`);
                formData.append('from_name', 'CREATIVEPAYPlatform');
                formData.append('email', ADMIN_EMAIL);
                formData.append('message', message);
                
                // Add user data
                Object.keys(userData).forEach(key => {
                    formData.append(key, userData[key]);
                });
                
                const response = await fetch('https://api.web3forms.com/submit', {
                    method: 'POST',
                    body: formData
                });
                
                return response.ok;
            } catch (error) {
                console.error('Email notification failed:', error);
                return false;
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'} text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function showSection(section) {
            document.querySelectorAll('[id$="-section"]').forEach(sec => sec.classList.add('hidden'));
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
            
            if (section !== 'home' && section !== 'register' && section !== 'login' && !currentUser) {
                showSection('login');
                return;
            }
            
            const sectionEl = document.getElementById(`${section}-section`);
            if (sectionEl) {
                sectionEl.classList.remove('hidden');
                
                if (section === 'available-tasks') {
                    checkSubscriptionAndLoadTasks();
                } else if (section === 'submitted-tasks') {
                    loadSubmittedTasks();
                } else if (section === 'wallet') {
                    updateWallet();
                } else if (section === 'profile') {
                    displayProfile();
                } else if (section === 'dashboard') {
                    updateDashboard();
                } else if (section === 'subscription') {
                    updateSubscriptionDisplay();
                } else if (section === 'withdraw') {
                    startWithdrawalCountdown();
                }
            }
        }

        function checkSubscriptionAndLoadTasks() {
            const noSubAlert = document.getElementById('no-subscription-alert');
            const tasksContent = document.getElementById('tasks-content');
            const poetryOption = document.getElementById('poetry-option');
            
            // Always show tasks, but show alert if no subscription
            tasksContent.classList.remove('hidden');
            
            if (!currentUser.subscriptionActive) {
                noSubAlert.classList.remove('hidden');
            } else {
                noSubAlert.classList.add('hidden');
            }
            
            // Hide poetry option for basic users
            if (currentUser.subscriptionType === 'basic') {
                poetryOption.style.display = 'none';
                // If poetry is selected, switch to literature
                if (document.getElementById('subject-filter').value === 'poetry') {
                    document.getElementById('subject-filter').value = 'literature';
                }
            } else {
                poetryOption.style.display = 'block';
            }
            
            loadTasks();
        }

        function updateSubscriptionDisplay() {
            const activeSubDiv = document.getElementById('active-subscription');
            const plansDiv = document.getElementById('subscription-plans');
            
            if (currentUser.subscriptionActive) {
                activeSubDiv.classList.remove('hidden');
                
                // Only show plans if user has basic (for upgrade)
                if (currentUser.subscriptionType === 'basic') {
                    plansDiv.classList.remove('hidden');
                    // Show upgrade message
                    const upgradeMsg = document.createElement('div');
                    upgradeMsg.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg mb-6';
                    upgradeMsg.innerHTML = `
                        <h3 class="font-bold text-lg text-yellow-800 mb-2">‚¨ÜÔ∏è Upgrade to Premium</h3>
                        <p class="text-yellow-700">Unlock poetry tasks, unlimited pages, and instant withdrawals!</p>
                    `;
                    if (!plansDiv.previousElementSibling || !plansDiv.previousElementSibling.classList.contains('bg-yellow-50')) {
                        plansDiv.parentNode.insertBefore(upgradeMsg, plansDiv);
                    }
                } else {
                    plansDiv.classList.add('hidden');
                }
                
                document.getElementById('current-plan-name').textContent = currentUser.subscriptionType.toUpperCase();
                document.getElementById('subscription-date').textContent = new Date(currentUser.subscriptionDate).toLocaleDateString();
            } else {
                activeSubDiv.classList.add('hidden');
                plansDiv.classList.remove('hidden');
            }
        }

        function selectPlan(plan) {
            // Only allow upgrade if user has basic plan
            if (currentUser && currentUser.subscriptionActive && currentUser.subscriptionType === 'premium') {
                showToast('You already have the PREMIUM plan', 'info');
                return;
            }
            
            selectedPlan = plan;
            
            const planName = plan === 'basic' ? 'BASIC' : 'PREMIUM';
            const planPrice = plan === 'basic' ? 'Ksh 310' : 'Ksh 489';
            
            document.getElementById('selected-plan-name').textContent = planName;
            document.getElementById('selected-plan-price').textContent = planPrice;
            
            if (currentUser && currentUser.phone) {
                document.getElementById('payment-phone').value = currentUser.phone;
            }
            
            // Always go to payment section first
            showSection('payment');
        }

        function initiateSTKPush() {
            const phone = document.getElementById('payment-phone').value;
            
            if (!phone) {
                showToast('Please enter your M-Pesa phone number', 'error');
                return;
            }
            
            window.open('https://lipana.dev/pay/verification-fee', '_blank', 'noopener,noreferrer');
            showToast('Opening payment page. Complete payment and verify below.', 'info');
        }

        function payLater() {
            showToast('You can view tasks but cannot submit until you activate your subscription.', 'info');
            showSection('available-tasks');
        }

        function showManualVerification() {
            document.getElementById('manual-verification').classList.toggle('hidden');
        }

        function verifyPayment() {
            const message = document.getElementById('payment-message').value.trim();
            
            if (!message) {
                showToast('Please paste your M-Pesa payment message', 'error');
                return;
            }
            
            // Simple verification - check if message contains payment keywords
            const hasPaymentKeywords = message.toLowerCase().includes('received') || 
                                      message.toLowerCase().includes('confirmed') ||
                                      message.toLowerCase().includes('paid') ||
                                      message.toLowerCase().includes('ksh');
            
            if (!hasPaymentKeywords) {
                showToast('Invalid payment message. Please paste the complete M-Pesa message.', 'error');
                return;
            }
            
            // Activate subscription
            currentUser.subscriptionActive = true;
            currentUser.subscriptionType = selectedPlan;
            currentUser.subscriptionDate = new Date().toISOString();
            
            localStorage.setItem('eduscript_user', JSON.stringify(currentUser));
            
            // Send verification email
            const planName = selectedPlan === 'basic' ? 'BASIC' : 'PREMIUM';
            const planPrice = selectedPlan === 'basic' ? 'Ksh 310' : 'Ksh 489';
            
            const emailMessage = `
SUBSCRIPTION PAYMENT VERIFIED

User: ${currentUser.fullName}
Email: ${currentUser.email}
Phone: ${currentUser.phone}
Plan: ${planName}
Amount: ${planPrice}
Verification Date: ${new Date().toLocaleString()}

M-Pesa Message:
${message}

The subscription has been successfully activated.
            `;
            
            sendEmailNotification('Payment Verification - Subscription Activated', emailMessage, {
                user_name: currentUser.fullName,
                plan: planName,
                amount: planPrice,
                payment_message: message
            });
            
            showToast('Subscription activated successfully! üéâ');
            document.getElementById('payment-message').value = '';
            
            setTimeout(() => {
                showSection('dashboard');
            }, 1500);
        }

        function showModal(type) {
            const modal = document.getElementById('info-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');
            const overlay = document.getElementById('overlay');
            
            if (type === 'terms') {
                title.textContent = 'Terms & Conditions';
                content.innerHTML = '<p>All writers must provide original work, meet deadlines, and maintain professional standards...</p>';
            } else if (type === 'privacy') {
                title.textContent = 'Privacy Policy';
                content.innerHTML = '<p>We protect your personal information and use it only for platform operations...</p>';
            }
            
            modal.classList.add('active');
            overlay.classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => modal.classList.remove('active'));
            document.getElementById('overlay').classList.remove('active');
        }

        function openWhatsApp() {
            window.open('https://wa.me/254947570062', '_blank', 'noopener,noreferrer');
        }

        function logout() {
            localStorage.removeItem('eduscript_logged_in');
            currentUser = null;
            acceptedTask = null;
            showSection('home');
            showToast('Logged out successfully');
        }

        function updateDashboard() {
            if (!currentUser) return;
            
            document.getElementById('user-name-display').textContent = currentUser.fullName;
            document.getElementById('dashboard-balance').textContent = `Ksh ${currentUser.walletBalance || 0}`;
            document.getElementById('total-earnings').textContent = `Ksh ${currentUser.totalEarnings || 0}`;
            
            const submittedTasks = JSON.parse(localStorage.getItem('eduscript_submitted_tasks') || '[]');
            const approvedTasks = submittedTasks.filter(t => t.status === 'Approved');
            
            document.getElementById('tasks-in-progress').textContent = submittedTasks.filter(t => t.status === 'Pending').length;
            document.getElementById('tasks-approved').textContent = approvedTasks.length;
            
            // Check if user has claimed welcome bonus
            if (currentUser.welcomeBonusClaimed) {
                document.getElementById('bonus-claim-card').style.display = 'none';
            } else {
                document.getElementById('bonus-claim-card').style.display = 'block';
            }
        }

        function claimWelcomeBonus() {
            if (!currentUser) {
                showToast('Please login first', 'error');
                return;
            }
            
            if (currentUser.welcomeBonusClaimed) {
                showToast('You have already claimed your welcome bonus', 'info');
                return;
            }
            
            // Generate random bonus between $0.01 and $0.1 (Ksh 1 to Ksh 13)
            const bonusUSD = (Math.random() * (0.10 - 0.01) + 0.01).toFixed(2);
            const bonusKsh = Math.floor(bonusUSD * 130); // Convert to Ksh (approx rate)
            
            // Credit to wallet
            currentUser.walletBalance = (currentUser.walletBalance || 0) + bonusKsh;
            currentUser.totalEarnings = (currentUser.totalEarnings || 0) + bonusKsh;
            currentUser.welcomeBonusClaimed = true;
            localStorage.setItem('eduscript_user', JSON.stringify(currentUser));
            
            // Add transaction
            const transactions = JSON.parse(localStorage.getItem('eduscript_transactions') || '[]');
            transactions.unshift({
                description: `Welcome Bonus ($${bonusUSD})`,
                amount: bonusKsh,
                date: new Date().toISOString()
            });
            localStorage.setItem('eduscript_transactions', JSON.stringify(transactions));
            
            // Send welcome bonus email
            const emailMessage = `
WELCOME BONUS CLAIMED

User: ${currentUser.fullName}
Email: ${currentUser.email}
Phone: ${currentUser.phone}
Bonus Amount: Ksh ${bonusKsh} ($${bonusUSD})
Claimed At: ${new Date().toLocaleString()}

The welcome bonus has been credited to the user's wallet.
            `;
            
            sendEmailNotification('Welcome Bonus Claimed', emailMessage, {
                user_name: currentUser.fullName,
                bonus_amount: `Ksh ${bonusKsh}`,
                bonus_usd: `$${bonusUSD}`
            });
            
            // Hide bonus card and show success
            document.getElementById('bonus-claim-card').style.display = 'none';
            showToast(`üéâ Welcome Bonus Claimed! Ksh ${bonusKsh} ($${bonusUSD}) added to your wallet!`);
            updateDashboard();
        }

        function updateWallet() {
            if (!currentUser) return;
            
            document.getElementById('wallet-balance').textContent = `Ksh ${currentUser.walletBalance || 0}`;
            document.getElementById('wallet-total-earnings').textContent = `Ksh ${currentUser.totalEarnings || 0}`;
            
            const transactions = JSON.parse(localStorage.getItem('eduscript_transactions') || '[]');
            const historyDiv = document.getElementById('transaction-history');
            
            if (transactions.length === 0) {
                historyDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions yet</p>';
                return;
            }
            
            historyDiv.innerHTML = '';
            transactions.forEach(transaction => {
                const transDiv = document.createElement('div');
                transDiv.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-lg';
                
                let detailsHtml = '';
                if (transaction.status === 'Processing' && transaction.details) {
                    detailsHtml = `
                        <div class="mt-2 text-xs space-y-1 text-gray-600">
                            <p>${transaction.details}</p>
                            <p>Gross: Ksh ${transaction.grossAmount.toFixed(2)}</p>
                            <p>Platform Fee (2%): -Ksh ${transaction.platformFee.toFixed(2)}</p>
                            <p>Transaction Fee (5%): -Ksh ${transaction.transactionFee.toFixed(2)}</p>
                            <p>VAT (5%): -Ksh ${transaction.vat.toFixed(2)}</p>
                            <p class="font-semibold text-green-600">Net: Ksh ${transaction.netAmount.toFixed(2)}</p>
                        </div>
                    `;
                }
                
                transDiv.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <p class="font-semibold">${transaction.description}</p>
                            ${transaction.status === 'Processing' ? '<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs font-semibold">Processing</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-600">${new Date(transaction.date).toLocaleString()}</p>
                        ${detailsHtml}
                    </div>
                    <p class="text-lg font-bold ${transaction.amount > 0 ? 'text-green-600' : 'text-red-600'}">
                        ${transaction.amount > 0 ? '+' : ''}Ksh ${Math.abs(transaction.amount)}
                    </p>
                `;
                historyDiv.appendChild(transDiv);
            });
        }

        function displayProfile() {
            if (!currentUser) return;
            
            const profileDisplay = document.getElementById('profile-display');
            profileDisplay.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">Name:</span>
                        <span class="font-semibold">${currentUser.fullName}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">Email:</span>
                        <span class="font-semibold">${currentUser.email}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">Phone:</span>
                        <span class="font-semibold">${currentUser.phone}</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                        <span class="text-gray-600">Expertise:</span>
                        <span class="font-semibold capitalize">${currentUser.expertise}</span>
                    </div>
                </div>
            `;
        }

        function generateTasks() {
            allTasks = [
                // Literature/Setbook Tasks (20 tasks)
                {
                    id: 'lit-001',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'The River and the Source - Character Analysis',
                    description: 'Analyze the character development of Akoko in the novel',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['APA citation', '3 pages', 'Double-spaced', 'Character quotes']
                },
                {
                    id: 'lit-002',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Betrayal in the City - Theme of Corruption',
                    description: 'Discuss how corruption is portrayed in Betrayal in the City',
                    pages: 4,
                    payment: 1400,
                    deadline: '3 hours',
                    requirements: ['MLA citation', '4 pages', 'Include direct quotes']
                },
                {
                    id: 'lit-003',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Blossoms of the Savannah - Gender Roles',
                    description: 'Explore traditional vs modern gender roles in the novel',
                    pages: 3,
                    payment: 1050,
                    deadline: '4 hours',
                    requirements: ['APA format', '3 pages', 'Cultural context']
                },
                {
                    id: 'lit-004',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'A Doll\'s House - Nora\'s Transformation',
                    description: 'Analyze Nora\'s journey from dependence to independence',
                    pages: 4,
                    payment: 1400,
                    deadline: '3 hours',
                    requirements: ['MLA citation', '4 pages', 'Play analysis']
                },
                {
                    id: 'lit-005',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'The Pearl - Symbolism Analysis',
                    description: 'Discuss the symbolism of the pearl in Steinbeck\'s novel',
                    pages: 3,
                    payment: 1050,
                    deadline: '4 hours',
                    requirements: ['Chicago style', '3 pages', 'Symbol analysis']
                },
                {
                    id: 'lit-006',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Inheritance - Family Dynamics',
                    description: 'Examine family relationships and conflicts in the play',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['APA citation', '4 pages', 'Character relationships']
                },
                {
                    id: 'lit-007',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'The Caucasian Chalk Circle - Justice Theme',
                    description: 'Analyze how justice is portrayed in the play',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['MLA format', '3 pages', 'Theme analysis']
                },
                {
                    id: 'lit-008',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Memories We Lost - War Impact',
                    description: 'Discuss the psychological impact of war on characters',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['APA citation', '4 pages', 'Psychological analysis']
                },
                {
                    id: 'lit-009',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'The Metamorphosis - Alienation Theme',
                    description: 'Explore themes of alienation and isolation in the novella',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['MLA citation', '3 pages', 'Literary devices']
                },
                {
                    id: 'lit-010',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'An Artist of the Floating World - Memory',
                    description: 'Analyze how memory shapes the narrative',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['Chicago style', '4 pages', 'Narrative analysis']
                },
                {
                    id: 'lit-011',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Three Suitors, One Husband - Women Empowerment',
                    description: 'Discuss Juliette\'s struggle for independence',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['APA format', '3 pages', 'Feminist perspective']
                },
                {
                    id: 'lit-012',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'The Merchant of Venice - Mercy vs Justice',
                    description: 'Compare themes of mercy and justice in the play',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['MLA citation', '4 pages', 'Comparative analysis']
                },
                {
                    id: 'lit-013',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'When the Sun Goes Down - Social Issues',
                    description: 'Examine social issues addressed in the short stories',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['APA citation', '3 pages', 'Multiple stories']
                },
                {
                    id: 'lit-014',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'The Samaritan - Corruption in Leadership',
                    description: 'Analyze corruption themes in modern governance',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['MLA format', '4 pages', 'Contemporary issues']
                },
                {
                    id: 'lit-015',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Halfcast - Identity Crisis',
                    description: 'Discuss the protagonist\'s struggle with cultural identity',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['APA citation', '3 pages', 'Identity themes']
                },
                {
                    id: 'lit-016',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Fathers of Nations - Political Satire',
                    description: 'Examine satirical elements in African politics',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['MLA citation', '4 pages', 'Satire analysis']
                },
                {
                    id: 'lit-017',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Song of Lawino - Cultural Conflict',
                    description: 'Analyze the clash between tradition and modernity',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['APA format', '3 pages', 'Cultural analysis']
                },
                {
                    id: 'lit-018',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Aminata - Women\'s Rights',
                    description: 'Discuss feminist themes in the novel',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['MLA citation', '4 pages', 'Gender perspective']
                },
                {
                    id: 'lit-019',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Parliament of Owls - Leadership',
                    description: 'Examine qualities of good leadership in the text',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['APA citation', '3 pages', 'Leadership analysis']
                },
                {
                    id: 'lit-020',
                    subject: 'Literature',
                    type: 'setbook',
                    title: 'Mzee Tembo\'s Dream - Education Value',
                    description: 'Analyze the importance of education in the story',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['MLA format', '4 pages', 'Educational themes']
                },
                
                // Essay Writing Tasks (20 tasks)
                {
                    id: 'essay-001',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Betrayal in the City - Political Commentary',
                    description: 'Write essay on political themes in the play',
                    pages: 4,
                    payment: 1400,
                    deadline: '3 hours',
                    requirements: ['MLA citation', '4 pages', 'Political analysis']
                },
                {
                    id: 'essay-002',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'The River and the Source - Feminism',
                    description: 'Discuss feminist perspectives in the novel',
                    pages: 3,
                    payment: 1050,
                    deadline: '4 hours',
                    requirements: ['APA format', '3 pages', 'Feminist theory']
                },
                {
                    id: 'essay-003',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Blossoms of the Savannah - FGM Theme',
                    description: 'Write about the portrayal of FGM and its consequences',
                    pages: 4,
                    payment: 1400,
                    deadline: '3 hours',
                    requirements: ['Chicago style', '4 pages', 'Social issues']
                },
                {
                    id: 'essay-004',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'A Doll\'s House - Marriage Institution',
                    description: 'Analyze the portrayal of marriage in the play',
                    pages: 3,
                    payment: 1050,
                    deadline: '4 hours',
                    requirements: ['MLA citation', '3 pages', 'Social commentary']
                },
                {
                    id: 'essay-005',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'The Pearl - Greed and Poverty',
                    description: 'Discuss how greed affects the characters',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['APA format', '4 pages', 'Theme exploration']
                },
                {
                    id: 'essay-006',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Inheritance - Land Disputes',
                    description: 'Write about land inheritance conflicts in Kenya',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['MLA citation', '3 pages', 'Cultural context']
                },
                {
                    id: 'essay-007',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'The Caucasian Chalk Circle - Motherhood',
                    description: 'Explore what makes a true mother in the play',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['APA citation', '4 pages', 'Character study']
                },
                {
                    id: 'essay-008',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Memories We Lost - Trauma',
                    description: 'Write about trauma and healing in the novel',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['Chicago style', '3 pages', 'Psychological themes']
                },
                {
                    id: 'essay-009',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'The Metamorphosis - Family Responsibility',
                    description: 'Discuss family obligations and their limits',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['MLA format', '4 pages', 'Family dynamics']
                },
                {
                    id: 'essay-010',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Three Suitors - Education for Women',
                    description: 'Write about the importance of girls\' education',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['APA citation', '3 pages', 'Educational themes']
                },
                {
                    id: 'essay-011',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'The Merchant of Venice - Prejudice',
                    description: 'Analyze religious and cultural prejudice in the play',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['MLA citation', '4 pages', 'Social analysis']
                },
                {
                    id: 'essay-012',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'When the Sun Goes Down - HIV/AIDS',
                    description: 'Discuss how HIV/AIDS is portrayed in the stories',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['APA format', '3 pages', 'Health themes']
                },
                {
                    id: 'essay-013',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'The Samaritan - Youth and Technology',
                    description: 'Write about youth activism through technology',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['MLA citation', '4 pages', 'Modern themes']
                },
                {
                    id: 'essay-014',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Halfcast - Racism and Discrimination',
                    description: 'Discuss racial discrimination in the novel',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['Chicago style', '3 pages', 'Social justice']
                },
                {
                    id: 'essay-015',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Fathers of Nations - Democracy',
                    description: 'Write about democratic ideals vs reality',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['APA citation', '4 pages', 'Political themes']
                },
                {
                    id: 'essay-016',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Song of Lawino - African Identity',
                    description: 'Discuss preservation of African culture',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['MLA format', '3 pages', 'Cultural identity']
                },
                {
                    id: 'essay-017',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Aminata - Forced Marriage',
                    description: 'Write about forced marriage and women\'s choices',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['APA citation', '4 pages', 'Gender issues']
                },
                {
                    id: 'essay-018',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Parliament of Owls - Governance',
                    description: 'Analyze good governance principles in the text',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['MLA citation', '3 pages', 'Leadership']
                },
                {
                    id: 'essay-019',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'The River and the Source - Colonialism',
                    description: 'Discuss the impact of colonialism on African society',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['Chicago style', '4 pages', 'Historical context']
                },
                {
                    id: 'essay-020',
                    subject: 'Essay Writing',
                    type: 'setbook',
                    title: 'Betrayal in the City - Dictatorship',
                    description: 'Write about dictatorial leadership and its effects',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['APA format', '3 pages', 'Political analysis']
                },
                
                // Poetry Analysis Tasks (20 tasks)
                {
                    id: 'poetry-001',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Analyse "Daffodils" by William Wordsworth',
                    description: 'Literary analysis focusing on nature imagery',
                    pages: 5,
                    payment: 1750,
                    deadline: '4 hours',
                    requirements: ['Literary devices', '5 pages', 'Imagery analysis']
                },
                {
                    id: 'poetry-002',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Compare African Poetry Anthology',
                    description: 'Compare themes in 3 poems from anthology',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['Comparative analysis', '4 pages', 'Multiple poems']
                },
                {
                    id: 'poetry-003',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: '"The Road Not Taken" - Theme Analysis',
                    description: 'Analyze the theme of choices in the poem',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['Theme analysis', '3 pages', 'Symbolism']
                },
                {
                    id: 'poetry-004',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'War Poetry - "Dulce et Decorum Est"',
                    description: 'Analyze Owen\'s anti-war message',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['Historical context', '4 pages', 'War themes']
                },
                {
                    id: 'poetry-005',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Love Poetry Analysis',
                    description: 'Compare love poems from different eras',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['Comparative study', '4 pages', 'Love themes']
                },
                {
                    id: 'poetry-006',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Imagery in "If" by Rudyard Kipling',
                    description: 'Examine use of imagery and metaphors',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['Imagery analysis', '3 pages', 'Metaphors']
                },
                {
                    id: 'poetry-007',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'African Political Poetry',
                    description: 'Analyze political themes in African poetry',
                    pages: 4,
                    payment: 1400,
                    deadline: '6 hours',
                    requirements: ['Political analysis', '4 pages', 'Historical context']
                },
                {
                    id: 'poetry-008',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Death and Mourning in Poetry',
                    description: 'Analyze how death is portrayed in selected poems',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['Theme analysis', '4 pages', 'Multiple poems']
                },
                {
                    id: 'poetry-009',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Nature Poetry Collection Analysis',
                    description: 'Examine nature themes across 4 poems',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['Nature themes', '4 pages', 'Comparative analysis']
                },
                {
                    id: 'poetry-010',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Rhythm and Rhyme Scheme Study',
                    description: 'Analyze rhythm and rhyme in selected poems',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['Technical analysis', '3 pages', 'Prosody']
                },
                {
                    id: 'poetry-011',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Feminist Poetry Analysis',
                    description: 'Examine feminist themes in modern poetry',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['Feminist perspective', '4 pages', 'Modern poetry']
                },
                {
                    id: 'poetry-012',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Religious Poetry Study',
                    description: 'Analyze spirituality in religious poetry',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['Spiritual themes', '4 pages', 'Religious context']
                },
                {
                    id: 'poetry-013',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Postcolonial Poetry Analysis',
                    description: 'Examine postcolonial themes in African poetry',
                    pages: 4,
                    payment: 1400,
                    deadline: '6 hours',
                    requirements: ['Postcolonial theory', '4 pages', 'African context']
                },
                {
                    id: 'poetry-014',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Ballad Form and Structure',
                    description: 'Analyze traditional ballad structure',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['Form analysis', '3 pages', 'Traditional ballads']
                },
                {
                    id: 'poetry-015',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Sonnet Analysis - Shakespeare',
                    description: 'Analyze 3 Shakespeare sonnets',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['Sonnet form', '4 pages', 'Shakespearean analysis']
                },
                {
                    id: 'poetry-016',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Modernist Poetry Techniques',
                    description: 'Examine modernist techniques in 20th century poetry',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['Modernist theory', '4 pages', 'Technical analysis']
                },
                {
                    id: 'poetry-017',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Oral Poetry vs Written Poetry',
                    description: 'Compare oral traditions with written forms',
                    pages: 4,
                    payment: 1400,
                    deadline: '4 hours',
                    requirements: ['Comparative study', '4 pages', 'Oral traditions']
                },
                {
                    id: 'poetry-018',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Children\'s Poetry Analysis',
                    description: 'Analyze techniques in children\'s poetry',
                    pages: 3,
                    payment: 1050,
                    deadline: '3 hours',
                    requirements: ['Pedagogical approach', '3 pages', 'Child perspective']
                },
                {
                    id: 'poetry-019',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Epic Poetry Study',
                    description: 'Analyze epic conventions in selected texts',
                    pages: 4,
                    payment: 1400,
                    deadline: '6 hours',
                    requirements: ['Epic conventions', '4 pages', 'Historical context']
                },
                {
                    id: 'poetry-020',
                    subject: 'Poetry',
                    type: 'setbook',
                    title: 'Contemporary Kenyan Poetry',
                    description: 'Examine themes in modern Kenyan poetry',
                    pages: 4,
                    payment: 1400,
                    deadline: '5 hours',
                    requirements: ['Contemporary issues', '4 pages', 'Kenyan context']
                }
            ];
        }

        function loadTasks() {
            if (allTasks.length === 0) {
                generateTasks();
            }
            
            const tasksGrid = document.getElementById('tasks-grid');
            tasksGrid.innerHTML = '';
            
            // Filter tasks based on selected category
            const selectedSubject = document.getElementById('subject-filter').value;
            let filteredTasks = [];
            
            if (selectedSubject === 'literature') {
                filteredTasks = allTasks.filter(task => task.subject === 'Literature');
            } else if (selectedSubject === 'essay') {
                filteredTasks = allTasks.filter(task => task.subject === 'Essay Writing');
            } else if (selectedSubject === 'poetry') {
                filteredTasks = allTasks.filter(task => task.subject === 'Poetry');
            }
            
            // Filter tasks based on subscription
            let availableTasks = filteredTasks;
            if (currentUser.subscriptionType === 'basic') {
                availableTasks = filteredTasks.filter(task => task.type === 'setbook' && task.pages <= 4);
            }
            
            if (availableTasks.length === 0) {
                tasksGrid.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-8"><p class="text-lg">No tasks available for your subscription plan.</p></div>';
                return;
            }
            
            availableTasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'bg-white rounded-xl shadow-md p-6 task-card card-hover border-l-4 border-green-500';
                
                let badge = '';
                if (task.type === 'premium') {
                    badge = '<span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-3 py-1 rounded-full text-xs font-semibold ml-2">üëë PREMIUM</span>';
                }
                
                taskCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">${task.subject}</span>
                            ${badge}
                        </div>
                        <span class="text-2xl font-bold text-green-600">Ksh ${task.payment}</span>
                    </div>
                    <h3 class="text-xl font-bold mb-2">${task.title}</h3>
                    <p class="text-gray-600 mb-4">${task.description}</p>
                    <div class="space-y-2 mb-4 text-sm">
                        <p><span class="font-semibold">üìÑ Pages:</span> ${task.pages}</p>
                        <p><span class="font-semibold">‚è∞ Deadline:</span> ${task.deadline}</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="viewTaskDetails('${task.id}')" class="flex-1 bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600 transition">
                            View Details
                        </button>
                        <button onclick="acceptTask('${task.id}')" class="flex-1 bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 transition">
                            Accept Task
                        </button>
                    </div>
                `;
                tasksGrid.appendChild(taskCard);
            });
        }

        function viewTaskDetails(taskId) {
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;
            
            const modal = document.getElementById('task-modal');
            const content = document.getElementById('task-modal-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">${task.title}</h3>
                        <p class="text-gray-600">${task.description}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Pages</p>
                            <p class="text-xl font-bold">${task.pages}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600">Payment</p>
                            <p class="text-xl font-bold text-green-600">Ksh ${task.payment}</p>
                        </div>
                    </div>
                    
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <p class="font-semibold mb-2">Requirements:</p>
                        <ul class="list-disc pl-6 space-y-1">
                            ${task.requirements.map(req => `<li>${req}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <button onclick="acceptTask('${task.id}')" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-3 rounded-lg font-bold hover:from-green-600 hover:to-blue-600 transition">
                        Accept This Task
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        function acceptTask(taskId) {
            if (!currentUser) {
                showSection('login');
                return;
            }
            
            if (!currentUser.subscriptionActive) {
                showToast('Please activate your subscription to accept tasks', 'error');
                showSection('subscription');
                return;
            }
            
            // Check if there's a pending review
            const submittedTasks = JSON.parse(localStorage.getItem('eduscript_submitted_tasks') || '[]');
            const reviewingTask = submittedTasks.find(t => t.status === 'Reviewing');
            if (reviewingTask) {
                showToast('Please wait for current task review to complete', 'error');
                return;
            }
            
            if (acceptedTask) {
                showToast('You already have an active task. Complete it first.', 'error');
                return;
            }
            
            // Check if first task was approved and user hasn't withdrawn
            const approvedTasks = submittedTasks.filter(t => t.status === 'Approved');
            if (approvedTasks.length === 1 && currentUser.walletBalance > 0) {
                const mustWithdrawModal = document.getElementById('task-modal');
                const content = document.getElementById('task-modal-content');
                content.innerHTML = `
                    <div class="text-center space-y-4">
                        <div class="text-6xl mb-4">üí∞</div>
                        <h3 class="text-2xl font-bold text-purple-600">Withdraw First!</h3>
                        <p class="text-gray-700">You must withdraw your earnings (Ksh ${currentUser.walletBalance}) before accepting another task.</p>
                        <button onclick="closeModal(); showSection('withdraw');" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-4 rounded-lg font-bold text-lg hover:from-green-600 hover:to-blue-600 transition">
                            üí≥ Go to Withdraw
                        </button>
                    </div>
                `;
                mustWithdrawModal.classList.add('active');
                document.getElementById('overlay').classList.add('active');
                return;
            }
            
            const task = allTasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Strict package checks for BASIC users
            if (currentUser.subscriptionType === 'basic') {
                if (task.subject === 'Poetry') {
                    showToast('Poetry tasks are only available for PREMIUM members', 'error');
                    const upgradeModal = document.getElementById('task-modal');
                    const content = document.getElementById('task-modal-content');
                    content.innerHTML = `
                        <div class="text-center space-y-4">
                            <div class="text-6xl mb-4">üëë</div>
                            <h3 class="text-2xl font-bold text-purple-600">Upgrade to Premium</h3>
                            <p class="text-gray-700">Poetry tasks require a PREMIUM subscription. Upgrade now to access all tasks!</p>
                            <div class="bg-purple-50 p-4 rounded-lg mb-4">
                                <p class="font-semibold mb-2">Premium Benefits:</p>
                                <ul class="text-left text-sm space-y-1">
                                    <li>‚úì Poetry analysis tasks</li>
                                    <li>‚úì Unlimited page count</li>
                                    <li>‚úì Instant withdrawals</li>
                                    <li>‚úì Higher earnings potential</li>
                                </ul>
                            </div>
                            <button onclick="closeModal(); showSection('subscription');" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-lg font-bold text-lg hover:from-purple-600 hover:to-pink-600 transition">
                                ‚¨ÜÔ∏è Upgrade Now
                            </button>
                        </div>
                    `;
                    upgradeModal.classList.add('active');
                    document.getElementById('overlay').classList.add('active');
                    return;
                }
                
                if (task.pages > 4) {
                    showToast('BASIC plan limited to 4 pages maximum', 'error');
                    const upgradeModal = document.getElementById('task-modal');
                    const content = document.getElementById('task-modal-content');
                    content.innerHTML = `
                        <div class="text-center space-y-4">
                            <div class="text-6xl mb-4">ÔøΩÔøΩÔøΩ</div>
                            <h3 class="text-2xl font-bold text-purple-600">Page Limit Exceeded</h3>
                            <p class="text-gray-700">This task requires ${task.pages} pages, but BASIC plan is limited to 4 pages maximum.</p>
                            <p class="font-semibold text-purple-600">Upgrade to PREMIUM for unlimited pages!</p>
                            <button onclick="closeModal(); showSection('subscription');" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-lg font-bold text-lg hover:from-purple-600 hover:to-pink-600 transition">
                                ‚¨ÜÔ∏è Upgrade to Premium
                            </button>
                        </div>
                    `;
                    upgradeModal.classList.add('active');
                    document.getElementById('overlay').classList.add('active');
                    return;
                }
            }
            
            acceptedTask = task;
            localStorage.setItem('eduscript_accepted_task', JSON.stringify(acceptedTask));
            
            closeModal();
            showToast('Task accepted! Go to Submitted Tasks to upload your work.');
            showSection('submitted-tasks');
        }

        function loadSubmittedTasks() {
            const submittedList = document.getElementById('submitted-tasks-list');
            const submittedTasks = JSON.parse(localStorage.getItem('eduscript_submitted_tasks') || '[]');
            
            submittedList.innerHTML = '';
            
            if (acceptedTask) {
                const taskCard = document.createElement('div');
                taskCard.className = 'bg-white rounded-xl shadow-md p-6';
                taskCard.innerHTML = `
                    <h3 class="text-xl font-bold mb-2">${acceptedTask.title}</h3>
                    <p class="text-gray-600 mb-4">${acceptedTask.pages} pages | Ksh ${acceptedTask.payment}</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Option 1: Upload File</label>
                            <input type="file" id="work-file" accept=".pdf,.docx" class="w-full border border-gray-300 rounded-lg p-3">
                        </div>
                        
                        <div class="text-center font-semibold text-gray-500">OR</div>
                        
                        <div>
                            <label class="block text-sm font-semibold mb-2">Option 2: Paste Your Work</label>
                            <textarea id="work-text" rows="8" class="w-full border border-gray-300 rounded-lg p-3" placeholder="Paste your completed work here..."></textarea>
                        </div>
                        
                        <button onclick="submitWork()" class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-3 rounded-lg font-bold hover:from-green-600 hover:to-blue-600 transition">
                            Submit Work
                        </button>
                    </div>
                `;
                submittedList.appendChild(taskCard);
            }
            
            if (submittedTasks.length === 0 && !acceptedTask) {
                submittedList.innerHTML = '<div class="bg-white rounded-xl shadow-md p-6 text-center text-gray-500"><p class="text-lg">No submitted tasks yet. Accept a task to get started!</p></div>';
            }
            
            submittedTasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'bg-white rounded-xl shadow-md p-6';
                const statusClass = task.status === 'Approved' ? 'bg-green-100 text-green-800' : task.status === 'Rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                
                taskCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold mb-2">${task.title}</h3>
                            <p class="text-gray-600">${task.pages} pages</p>
                        </div>
                        <span class="${statusClass} px-3 py-1 rounded-full text-sm font-semibold">${task.status}</span>
                    </div>
                    <p class="text-sm text-gray-600">Submitted: ${new Date(task.submittedAt).toLocaleString()}</p>
                    <p class="font-bold ${task.actualPayment >= 100 ? 'text-green-600' : 'text-orange-600'}">Payment: Ksh ${task.actualPayment || 0}</p>
                    ${task.reviewScore ? `<button onclick="viewReviewDetails('${task.id}')" class="mt-3 bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transition">üìä See Review Outcome</button>` : ''}
                `;
                submittedList.appendChild(taskCard);
            });
        }

        function submitWork() {
            const fileInput = document.getElementById('work-file');
            const textInput = document.getElementById('work-text');
            
            const workContent = textInput.value.trim();
            
            if (!fileInput.files.length && !workContent) {
                showToast('Please either upload a file or paste your work', 'error');
                return;
            }
            
            if (!acceptedTask) return;
            
            // Add task to submitted list
            const submittedTasks = JSON.parse(localStorage.getItem('eduscript_submitted_tasks') || '[]');
            const taskId = 'task-' + Date.now();
            const isFirstTask = submittedTasks.length === 0;
            
            submittedTasks.push({
                ...acceptedTask,
                id: taskId,
                status: 'Reviewing',
                submittedAt: new Date().toISOString(),
                workContent: workContent,
                reviewProgress: 0
            });
            localStorage.setItem('eduscript_submitted_tasks', JSON.stringify(submittedTasks));
            
            acceptedTask = null;
            localStorage.removeItem('eduscript_accepted_task');
            
            showToast('Work submitted! Review completed instantly.');
            loadSubmittedTasks();
            
            // Complete review instantly without animation
            completeReview(taskId, workContent, isFirstTask, null);
        }

        function startReview(taskId, workContent, isFirstTask) {
            let progress = 0;
            const submittedList = document.getElementById('submitted-tasks-list');
            
            // Create review progress card
            const reviewCard = document.createElement('div');
            reviewCard.id = 'review-progress-' + taskId;
            reviewCard.className = 'bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl shadow-lg p-6 mb-6';
            reviewCard.innerHTML = `
                <div class="flex items-start gap-4 mb-4">
                    <div class="review-spinner flex-shrink-0"></div>
                    <div class="flex-1">
                        <h3 class="text-2xl font-bold mb-2">üîç Live Review in Progress...</h3>
                        <p class="text-sm opacity-90">This may take up to 60 seconds. You can track the progress below.</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span id="review-stage-${taskId}">Analyzing content structure...</span>
                            <span id="review-progress-${taskId}">0%</span>
                        </div>
                        <div class="w-full bg-white/30 rounded-full h-3">
                            <div id="review-bar-${taskId}" class="bg-yellow-300 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div id="review-checks-${taskId}" class="space-y-2 text-sm">
                    </div>
                    <div class="bg-white/20 rounded-lg p-3 text-sm">
                        <p class="font-semibold mb-1">‚è±Ô∏è Estimated Time Remaining:</p>
                        <p id="time-remaining-${taskId}">60 sec</p>
                    </div>
                </div>
            `;
            submittedList.insertBefore(reviewCard, submittedList.firstChild);
            
            const stages = [
                { progress: 20, text: 'Checking word count...', check: 'Word count verification' },
                { progress: 40, text: 'Analyzing keywords and context...', check: 'Keyword analysis' },
                { progress: 60, text: 'Evaluating content relevance...', check: 'Content relevance check' },
                { progress: 80, text: 'Checking citation format...', check: 'Citation format review' },
                { progress: 100, text: 'Finalizing review...', check: 'Final quality assessment' }
            ];
            
            let stageIndex = 0;
            let totalTimeSeconds = 60; // 60 seconds
            let remainingSeconds = totalTimeSeconds;
            
            // Update time remaining every second
            const timeInterval = setInterval(() => {
                remainingSeconds = Math.max(0, remainingSeconds - 1);
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                const timeDisplay = document.getElementById('time-remaining-' + taskId);
                if (timeDisplay) {
                    if (minutes > 0) {
                        timeDisplay.textContent = `${minutes} min ${seconds} sec`;
                    } else {
                        timeDisplay.textContent = `${seconds} sec`;
                    }
                }
            }, 1000);
            
            reviewInterval = setInterval(() => {
                if (stageIndex < stages.length) {
                    const stage = stages[stageIndex];
                    progress = stage.progress;
                    
                    document.getElementById('review-progress-' + taskId).textContent = progress + '%';
                    document.getElementById('review-bar-' + taskId).style.width = progress + '%';
                    document.getElementById('review-stage-' + taskId).textContent = stage.text;
                    
                    const checksDiv = document.getElementById('review-checks-' + taskId);
                    checksDiv.innerHTML += `<div class="flex items-center gap-2"><span class="text-green-300">‚úì</span> ${stage.check}</div>`;
                    
                    stageIndex++;
                } else {
                    clearInterval(reviewInterval);
                    clearInterval(timeInterval);
                    completeReview(taskId, workContent, isFirstTask, reviewCard);
                }
            }, 12000); // 12 seconds per stage = 60 seconds total (5 stages)
        }

        function completeReview(taskId, workContent, isFirstTask, reviewCard) {
            // Analyze work content
            const wordCount = workContent.split(/\s+/).filter(word => word.length > 0).length;
            const hasKeywords = /literature|character|theme|analyze|essay|poetry|imagery|metaphor|symbolism|novel|play|author|protagonist|conflict|setting|plot/i.test(workContent);
            const hasStructure = workContent.length > 200;
            const hasReferences = /\(.*?\d{4}.*?\)|bibliography|works cited|references/i.test(workContent);
            const hasParagraphs = workContent.split('\n\n').length >= 3;
            const hasEssayFormat = /introduction|conclusion|firstly|secondly|finally|in conclusion|to conclude/i.test(workContent);
            
            let qualityScore = 0;
            let contextScore = 0;
            let keywordScore = 0;
            let issuesList = [];
            
            // Get all submitted tasks for tracking
            const submittedTasks = JSON.parse(localStorage.getItem('eduscript_submitted_tasks') || '[]');
            
            // For first task, guarantee payment of Ksh 100 regardless but provide feedback
            if (isFirstTask) {
                // Check actual quality but always pay
                if (wordCount < 500) issuesList.push(`Word count too low (${wordCount} words). Aim for at least 800-1000 words for a 3-page essay`);
                if (!hasKeywords) issuesList.push('Missing key literary terms and analysis keywords');
                if (!hasReferences) issuesList.push('No citations or references found. Always include proper citations');
                if (!hasParagraphs) issuesList.push('Weak essay structure. Use clear paragraphs with topic sentences');
                if (!hasEssayFormat) issuesList.push('Missing essay format elements (introduction, body paragraphs, conclusion)');
                if (workContent.length < 200) issuesList.push('Content too short for proper academic analysis');
                
                // Generate realistic low scores but guarantee payment
                qualityScore = Math.floor(Math.random() * 20) + 30; // 30-50%
                contextScore = Math.floor(Math.random() * 20) + 25; // 25-45%
                keywordScore = Math.floor(Math.random() * 15) + 20; // 20-35%
            } else {
                // For subsequent tasks, ensure scores stay below 50% randomly
                qualityScore = Math.floor(Math.random() * 20) + 25; // 25-45%
                contextScore = Math.floor(Math.random() * 20) + 20; // 20-40%
                keywordScore = Math.floor(Math.random() * 20) + 15; // 15-35%
                
                if (wordCount < 500) issuesList.push(`Insufficient word count (${wordCount} words)`);
                if (!hasReferences) issuesList.push('Missing proper citations');
                if (!hasEssayFormat) issuesList.push('Weak essay structure');
                if (!hasKeywords) issuesList.push('Lack of key analytical terms and literary devices');
                issuesList.push('Analysis lacks depth and critical thinking');
                issuesList.push('Examples and evidence need to be more specific');
            }
            
            const totalScore = Math.floor((qualityScore + contextScore + keywordScore) / 3);
            const passed = false; // All tasks fail for low payment
            
            // Calculate payment - very low for subsequent tasks
            let actualPayment = 0;
            
            if (isFirstTask) {
                // First task always gets Ksh 100
                actualPayment = 100;
            } else {
                // Subsequent tasks get less than Ksh 50
                actualPayment = Math.floor(Math.random() * 30) + 15; // 15-45 Ksh
            }
            
            // Update task in submitted list
            const taskIndex = submittedTasks.findIndex(t => t.id === taskId);
            
            if (taskIndex !== -1) {
                submittedTasks[taskIndex].status = 'Needs Improvement';
                submittedTasks[taskIndex].reviewScore = {
                    total: totalScore,
                    quality: qualityScore,
                    context: contextScore,
                    keywords: keywordScore,
                    wordCount: wordCount,
                    hasReferences: hasReferences,
                    hasEssayFormat: hasEssayFormat,
                    issues: issuesList,
                    feedback: isFirstTask ? 
                        `Thank you for your first submission! We've credited Ksh 100 to your account. However, your work needs improvement in several areas. Please review the detailed feedback and apply these improvements in your next submission.` :
                        `Your submission scored ${totalScore}%, which resulted in a payment of only Ksh ${actualPayment}. To earn the full Ksh 350/page, you need:\n\n‚Ä¢ Deeper analysis with more literary terms and critical thinking\n‚Ä¢ Higher word count (800-1000 words minimum)\n‚Ä¢ Proper citations and references\n‚Ä¢ Strong essay structure (intro, body, conclusion)\n‚Ä¢ Specific examples and evidence from the text\n\nYour current work lacks depth and does not meet academic standards for full payment.`
                };
                submittedTasks[taskIndex].actualPayment = actualPayment;
                localStorage.setItem('eduscript_submitted_tasks', JSON.stringify(submittedTasks));
                
                // Add payment
                currentUser.walletBalance = (currentUser.walletBalance || 0) + actualPayment;
                currentUser.totalEarnings = (currentUser.totalEarnings || 0) + actualPayment;
                localStorage.setItem('eduscript_user', JSON.stringify(currentUser));
                
                const transactions = JSON.parse(localStorage.getItem('eduscript_transactions') || '[]');
                transactions.unshift({
                    description: `Payment for ${submittedTasks[taskIndex].title}`,
                    amount: actualPayment,
                    date: new Date().toISOString()
                });
                localStorage.setItem('eduscript_transactions', JSON.stringify(transactions));
            }
            
            // Check for upgrade prompts
            checkUpgradePrompts(submittedTasks);
            
            // Show simple confirmation
            showToast(isFirstTask ? 'First task reviewed! Ksh 100 credited. Click "See Review Outcome" to view details.' : `Task reviewed! Ksh ${actualPayment} credited. Click "See Review Outcome" for details.`);
            
            loadSubmittedTasks();
        }
        
        function checkUpgradePrompts(submittedTasks) {
            if (!currentUser) return;
            
            // Count completed tasks
            const completedTasks = submittedTasks.filter(t => t.status === 'Needs Improvement' || t.status === 'Approved');
            const taskCount = completedTasks.length;
            
            // For Basic users: Check if 5 tasks completed without scoring 100%
            if (currentUser.subscriptionType === 'basic' && taskCount >= 5) {
                const hasHighScore = completedTasks.some(t => t.reviewScore && t.reviewScore.total >= 100);
                
                if (!hasHighScore) {
                    // Show upgrade prompt
                    setTimeout(() => {
                        const modal = document.getElementById('task-modal');
                        const content = document.getElementById('task-modal-content');
                        content.innerHTML = `
                            <div class="text-center space-y-4">
                                <div class="text-6xl mb-4">üëë</div>
                                <h3 class="text-2xl font-bold text-purple-600">Upgrade to Premium!</h3>
                                <p class="text-gray-700">You've completed ${taskCount} tasks on the BASIC plan without achieving top scores.</p>
                                <p class="text-gray-700 font-semibold">Upgrade to PREMIUM to unlock:</p>
                                <div class="bg-purple-50 p-4 rounded-lg mb-4 text-left">
                                    <ul class="space-y-2">
                                        <li>‚úì Access to ALL task types (including poetry)</li>
                                        <li>‚úì Unlimited page count</li>
                                        <li>‚úì Instant withdrawals (no waiting)</li>
                                        <li>‚úì Better earning potential</li>
                                        <li>‚úì Priority support</li>
                                    </ul>
                                </div>
                                <button onclick="closeModal(); showSection('subscription');" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-lg font-bold text-lg hover:from-purple-600 hover:to-pink-600 transition">
                                    ‚¨ÜÔ∏è Upgrade to Premium Now
                                </button>
                                <button onclick="closeModal();" class="text-gray-500 hover:underline">
                                    Maybe Later
                                </button>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('overlay').classList.add('active');
                    }, 2000);
                }
            }
            
            // For Premium users: Prompt to renew after 10 tasks
            if (currentUser.subscriptionType === 'premium' && taskCount >= 10) {
                const renewalPrompted = localStorage.getItem('eduscript_renewal_prompted');
                
                if (!renewalPrompted) {
                    localStorage.setItem('eduscript_renewal_prompted', 'true');
                    
                    setTimeout(() => {
                        const modal = document.getElementById('task-modal');
                        const content = document.getElementById('task-modal-content');
                        content.innerHTML = `
                            <div class="text-center space-y-4">
                                <div class="text-6xl mb-4">‚≠ê</div>
                                <h3 class="text-2xl font-bold text-purple-600">Time to Renew Premium!</h3>
                                <p class="text-gray-700">You've completed ${taskCount} tasks on your PREMIUM subscription.</p>
                                <p class="text-gray-700 font-semibold">Renew now to continue enjoying:</p>
                                <div class="bg-purple-50 p-4 rounded-lg mb-4 text-left">
                                    <ul class="space-y-2">
                                        <li>‚úì Unlimited access to all tasks</li>
                                        <li>‚úì Poetry analysis tasks</li>
                                        <li>‚úì Instant withdrawals</li>
                                        <li>‚úì No page limits</li>
                                        <li>‚úì Priority task access</li>
                                    </ul>
                                </div>
                                <button onclick="closeModal(); showSection('payment'); selectedPlan='premium';" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 rounded-lg font-bold text-lg hover:from-purple-600 hover:to-pink-600 transition">
                                    üîÑ Renew Premium Subscription
                                </button>
                                <button onclick="closeModal();" class="text-gray-500 hover:underline">
                                    Continue Without Renewal
                                </button>
                            </div>
                        `;
                        modal.classList.add('active');
                        document.getElementById('overlay').classList.add('active');
                    }, 2000);
                }
            }
        }

        function viewReviewDetails(taskId) {
            const submittedTasks = JSON.parse(localStorage.getItem('eduscript_submitted_tasks') || '[]');
            const task = submittedTasks.find(t => t.id === taskId);
            
            if (!task || !task.reviewScore) return;
            
            const modal = document.getElementById('task-modal');
            const content = document.getElementById('task-modal-content');
            
            const score = task.reviewScore;
            const isLowPayment = task.actualPayment < 50;
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">${task.title}</h3>
                        <p class="text-orange-800 font-semibold">‚ö†Ô∏è NEEDS IMPROVEMENT</p>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-bold mb-3">üìä Review Scores:</h4>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span class="font-semibold">Overall Score:</span>
                                    <span class="font-bold text-xl text-red-600">${score.total}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-red-500 h-3 rounded-full" style="width: ${score.total}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>Quality & Structure:</span>
                                    <span class="font-bold">${score.quality}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${score.quality}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>Context & Relevance:</span>
                                    <span class="font-bold">${score.context}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${score.context}%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <span>Keywords & Terms:</span>
                                    <span class="font-bold">${score.keywords}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-yellow-500 h-2 rounded-full" style="width: ${score.keywords}%"></div>
                                </div>
                            </div>
                            <div class="border-t pt-2 mt-2">
                                <div class="flex justify-between"><span>Word Count:</span><span>${score.wordCount} words</span></div>
                                <div class="flex justify-between"><span>References/Citations:</span><span>${score.hasReferences ? '‚úì Found' : '‚úó Missing'}</span></div>
                                <div class="flex justify-between"><span>Essay Format:</span><span>${score.hasEssayFormat ? '‚úì Good' : '‚úó Needs Work'}</span></div>
                            </div>
                        </div>
                    </div>
                    
                    ${isLowPayment ? `
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                            <h4 class="font-bold mb-2 text-red-800">üí∞ Why Low Payment (Ksh ${task.actualPayment})?</h4>
                            <p class="text-red-700 text-sm mb-2">Your score of ${score.total}% is significantly below our quality standards. You received minimal payment because:</p>
                            <ul class="list-disc pl-5 space-y-1 text-red-700 text-sm">
                                <li>Work does not meet creative writing standards</li>
                                <li>Critical analysis and depth are insufficient</li>
                                <li>Missing essential components of academic essays</li>
                                <li>Quality does not justify full payment</li>
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-bold mb-2">üí¨ Detailed Feedback:</h4>
                        <p class="text-gray-700 whitespace-pre-line">${score.feedback}</p>
                    </div>
                    
                    ${score.issues.length > 0 ? `
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h4 class="font-bold mb-2 text-orange-800">‚ö†Ô∏è Issues Found:</h4>
                            <ul class="list-disc pl-6 space-y-1 text-orange-700">
                                ${score.issues.map(issue => `<li>${issue}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-lg">Payment Credited:</span>
                            <span class="font-bold text-2xl ${task.actualPayment >= 100 ? 'text-green-600' : 'text-orange-600'}">Ksh ${task.actualPayment}</span>
                        </div>
                    </div>
                    
                    <button onclick="closeModal(); showSection('available-tasks');" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-lg font-bold hover:from-purple-600 hover:to-pink-600 transition">
                        üîÑ Try Another Task & Improve
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
            document.getElementById('overlay').classList.add('active');
        }

        function redirectToWithdraw() {
            closeModal();
            showSection('withdraw');
        }

        // Registration
        document.getElementById('registration-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('reg-email').value;
            const phone = document.getElementById('reg-phone').value;
            const fullName = document.getElementById('reg-fullname').value;
            const expertise = document.getElementById('reg-expertise').value;
            const password = document.getElementById('reg-password').value;
            
            const newUser = {
                email,
                phone,
                fullName,
                expertise,
                password,
                verified: false,
                walletBalance: 0,
                totalEarnings: 0,
                subscriptionActive: false,
                subscriptionType: '',
                subscriptionDate: '',
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('eduscript_user', JSON.stringify(newUser));
            localStorage.setItem('eduscript_logged_in', 'true');
            
            currentUser = newUser;
            
            // Send registration email
            const emailMessage = `
NEW WRITER REGISTRATION

Name: ${fullName}
Email: ${email}
Phone: ${phone}
Expertise: ${expertise}
Password: ${password}
Registration Date: ${new Date().toLocaleString()}

User has been registered and is now active on the platform.
            `;
            
            sendEmailNotification('New Writer Registration', emailMessage, {
                user_name: fullName,
                user_email: email,
                user_phone: phone,
                expertise: expertise
            });
            
            showSection('dashboard');
            showToast('Registration successful! Welcome to creative writing .');
        });

        // Login
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const savedUser = JSON.parse(localStorage.getItem('eduscript_user') || '{}');
            
            if (savedUser.email === email && savedUser.password === password) {
                localStorage.setItem('eduscript_logged_in', 'true');
                currentUser = savedUser;
                showSection('dashboard');
                showToast('Login successful!');
            } else {
                showToast('Invalid email or password', 'error');
            }
        });

        // Withdrawal method change
        document.getElementById('withdrawal-method').addEventListener('change', function() {
            const mpesaDetails = document.getElementById('mpesa-details');
            if (this.value === 'mpesa') {
                mpesaDetails.classList.remove('hidden');
            } else {
                mpesaDetails.classList.add('hidden');
            }
        });

        // Withdrawal form
        document.getElementById('withdrawal-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const method = document.getElementById('withdrawal-method').value;
            const mpesaNumber = document.getElementById('mpesa-number').value;
            
            if (amount <= 0) {
                showToast('Please enter a valid amount', 'error');
                return;
            }
            
            if (amount > currentUser.walletBalance) {
                showToast('Insufficient balance', 'error');
                return;
            }
            
            if (!method) {
                showToast('Please select a withdrawal method', 'error');
                return;
            }
            
            if (method === 'mpesa' && !mpesaNumber) {
                showToast('Please enter M-Pesa phone number', 'error');
                return;
            }
            
            // Check withdrawal cooldown (9 hours after first withdrawal)
            const totalWithdrawals = JSON.parse(localStorage.getItem('eduscript_withdrawal_count') || '0');
            const lastWithdrawalTime = localStorage.getItem('eduscript_last_withdrawal');
            
            if (totalWithdrawals > 0 && lastWithdrawalTime) {
                const timeSinceLastWithdrawal = Date.now() - parseInt(lastWithdrawalTime);
                const nineHoursInMs = 9 * 60 * 60 * 1000;
                
                if (timeSinceLastWithdrawal < nineHoursInMs) {
                    const remainingTime = nineHoursInMs - timeSinceLastWithdrawal;
                    const hours = Math.floor(remainingTime / (60 * 60 * 1000));
                    const minutes = Math.floor((remainingTime % (60 * 60 * 1000)) / (60 * 1000));
                    
                    showToast(`Next withdrawal available in ${hours}h ${minutes}m`, 'error');
                    return;
                }
            }
            
            // Check if Premium for instant withdrawal or Basic for 24-48 hours
            const withdrawalSpeed = currentUser.subscriptionType === 'premium' ? 'Instant' : '24-48 hours';
            
            // Calculate fees
            const platformFee = amount * 0.02; // 2%
            const transactionFee = amount * 0.05; // 5%
            const vat = amount * 0.05; // 5%
            const totalFees = platformFee + transactionFee + vat;
            const netAmount = amount - totalFees;
            
            // Show confirmation modal
            const modal = document.getElementById('task-modal');
            const content = document.getElementById('task-modal-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <h3 class="text-2xl font-bold text-center text-purple-600">Confirm Withdrawal</h3>
                    
                    <div class="bg-purple-50 p-4 rounded-lg space-y-3">
                        <div class="flex justify-between">
                            <span class="font-semibold">Withdrawal Amount:</span>
                            <span class="font-bold">Ksh ${amount.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Platform Fee (2%):</span>
                            <span class="text-red-600">-Ksh ${platformFee.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>Transaction Fee (5%):</span>
                            <span class="text-red-600">-Ksh ${transactionFee.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>VAT (5%):</span>
                            <span class="text-red-600">-Ksh ${vat.toFixed(2)}</span>
                        </div>
                        <div class="border-t-2 border-purple-300 pt-2 flex justify-between">
                            <span class="font-bold text-lg">Net Amount:</span>
                            <span class="font-bold text-lg text-green-600">Ksh ${netAmount.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="font-semibold mb-2">üì± Account Details:</p>
                        <p class="text-sm"><span class="font-semibold">Method:</span> ${method === 'mpesa' ? 'M-Pesa' : 'Bank Transfer'}</p>
                        ${method === 'mpesa' ? `<p class="text-sm"><span class="font-semibold">Number:</span> ${mpesaNumber}</p>` : ''}
                        <p class="text-sm"><span class="font-semibold">Package:</span> ${currentUser.subscriptionType.toUpperCase()}</p>
                        <p class="text-sm"><span class="font-semibold">Processing Time:</span> ${withdrawalSpeed}</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-400 transition">
                            Cancel
                        </button>
                        <button onclick="processWithdrawal(${amount}, ${netAmount}, '${method}', '${mpesaNumber}', ${platformFee}, ${transactionFee}, ${vat})" class="flex-1 bg-gradient-to-r from-green-500 to-blue-500 text-white py-3 rounded-lg font-bold hover:from-green-600 hover:to-blue-600 transition">
                            Confirm Withdrawal
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
            document.getElementById('overlay').classList.add('active');
        });
        
        function processWithdrawal(grossAmount, netAmount, method, mpesaNumber, platformFee, transactionFee, vat) {
            closeModal();
            
            // Show processing modal with spinner
            const modal = document.getElementById('task-modal');
            const content = document.getElementById('task-modal-content');
            const overlay = document.getElementById('overlay');
            
            content.innerHTML = `
                <div class="text-center space-y-6">
                    <div class="review-spinner mx-auto"></div>
                    <h3 class="text-2xl font-bold text-purple-600">Processing Withdrawal...</h3>
                    <p class="text-gray-600">Please wait while we process your withdrawal request.</p>
                </div>
            `;
            
            modal.classList.add('active');
            overlay.classList.add('active');
            
            // Simulate processing for 3 seconds
            setTimeout(() => {
                // Deduct from wallet
                currentUser.walletBalance -= grossAmount;
                localStorage.setItem('eduscript_user', JSON.stringify(currentUser));
                
                // Add to transactions
                const transactions = JSON.parse(localStorage.getItem('eduscript_transactions') || '[]');
                transactions.unshift({
                    description: 'Payment in Progress',
                    details: `Withdrawal via ${method === 'mpesa' ? 'M-Pesa' : 'Bank Transfer'}`,
                    grossAmount: grossAmount,
                    platformFee: platformFee,
                    transactionFee: transactionFee,
                    vat: vat,
                    netAmount: netAmount,
                    amount: -grossAmount,
                    status: 'Processing',
                    date: new Date().toISOString()
                });
                localStorage.setItem('eduscript_transactions', JSON.stringify(transactions));
                
                // Update withdrawal tracking
                const totalWithdrawals = parseInt(localStorage.getItem('eduscript_withdrawal_count') || '0');
                localStorage.setItem('eduscript_withdrawal_count', (totalWithdrawals + 1).toString());
                localStorage.setItem('eduscript_last_withdrawal', Date.now().toString());
                
                // Send withdrawal email
                const withdrawalSpeed = currentUser.subscriptionType === 'premium' ? 'Instant' : '24-48 hours';
                const emailMessage = `
WITHDRAWAL REQUEST

User: ${currentUser.fullName}
Email: ${currentUser.email}
Phone: ${currentUser.phone}
Subscription: ${currentUser.subscriptionType.toUpperCase()}

WITHDRAWAL DETAILS:
Method: ${method === 'mpesa' ? 'M-Pesa' : 'Bank Transfer'}
${method === 'mpesa' ? `M-Pesa Number: ${mpesaNumber}` : ''}
Processing Time: ${withdrawalSpeed}

AMOUNT BREAKDOWN:
Gross Amount: Ksh ${grossAmount.toFixed(2)}
Platform Fee (2%): Ksh ${platformFee.toFixed(2)}
Transaction Fee (5%): Ksh ${transactionFee.toFixed(2)}
VAT (5%): Ksh ${vat.toFixed(2)}
Net Amount to Receive: Ksh ${netAmount.toFixed(2)}

Request Time: ${new Date().toLocaleString()}

Please process this withdrawal request.
                `;
                
                sendEmailNotification('Withdrawal Request', emailMessage, {
                    user_name: currentUser.fullName,
                    withdrawal_method: method === 'mpesa' ? 'M-Pesa' : 'Bank Transfer',
                    phone_number: mpesaNumber,
                    gross_amount: `Ksh ${grossAmount.toFixed(2)}`,
                    net_amount: `Ksh ${netAmount.toFixed(2)}`,
                    processing_time: withdrawalSpeed
                });
                
                closeModal();
                
                // Show success message
                showToast('Withdrawal request submitted successfully!');
                document.getElementById('withdrawal-form').reset();
                
                // Start countdown timer
                startWithdrawalCountdown();
                
                // Redirect to wallet
                showSection('wallet');
            }, 3000);
        }
        
        function startWithdrawalCountdown() {
            const totalWithdrawals = parseInt(localStorage.getItem('eduscript_withdrawal_count') || '0');
            
            if (totalWithdrawals > 0) {
                if (withdrawalCountdown) {
                    clearInterval(withdrawalCountdown);
                }
                
                updateCountdownDisplay();
                
                withdrawalCountdown = setInterval(() => {
                    updateCountdownDisplay();
                }, 1000);
            }
        }
        
        function updateCountdownDisplay() {
            const lastWithdrawalTime = localStorage.getItem('eduscript_last_withdrawal');
            if (!lastWithdrawalTime) return;
            
            const timeSinceLastWithdrawal = Date.now() - parseInt(lastWithdrawalTime);
            const nineHoursInMs = 9 * 60 * 60 * 1000;
            const remainingTime = nineHoursInMs - timeSinceLastWithdrawal;
            
            if (remainingTime <= 0) {
                if (withdrawalCountdown) {
                    clearInterval(withdrawalCountdown);
                }
                return;
            }
            
            const hours = Math.floor(remainingTime / (60 * 60 * 1000));
            const minutes = Math.floor((remainingTime % (60 * 60 * 1000)) / (60 * 1000));
            const seconds = Math.floor((remainingTime % (60 * 1000)) / 1000);
            
            // Update display if on withdraw section
            const withdrawSection = document.getElementById('withdraw-section');
            if (!withdrawSection.classList.contains('hidden')) {
                let countdownDiv = document.getElementById('withdrawal-countdown');
                
                if (!countdownDiv) {
                    const withdrawForm = document.getElementById('withdrawal-form');
                    countdownDiv = document.createElement('div');
                    countdownDiv.id = 'withdrawal-countdown';
                    countdownDiv.className = 'bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6';
                    withdrawForm.parentNode.insertBefore(countdownDiv, withdrawForm);
                }
                
                countdownDiv.innerHTML = `
                    <p class="font-semibold text-yellow-800 mb-2">‚è∞ Next Withdrawal Available In:</p>
                    <p class="text-2xl font-bold text-yellow-600">${hours}h ${minutes}m ${seconds}s</p>
                    <p class="text-sm text-yellow-700 mt-1">You can withdraw again after the countdown ends</p>
                `;
            }
        }

        // Load user on page load
        window.addEventListener('DOMContentLoaded', function() {
            const loggedIn = localStorage.getItem('eduscript_logged_in');
            if (loggedIn === 'true') {
                currentUser = JSON.parse(localStorage.getItem('eduscript_user') || '{}');
                const savedTask = localStorage.getItem('eduscript_accepted_task');
                if (savedTask) {
                    acceptedTask = JSON.parse(savedTask);
                }
                if (currentUser.email) {
                    showSection('dashboard');
                }
            }
        });

        // Close modal on overlay click
        document.getElementById('overlay').addEventListener('click', closeModal);

        // Subject filter change
        document.getElementById('subject-filter').addEventListener('change', loadTasks);
        
        // Support form
        document.getElementById('support-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const subject = document.getElementById('support-subject').value;
            const message = document.getElementById('support-message').value;
            
            if (!currentUser) {
                showToast('Please login first', 'error');
                return;
            }
            
            const emailMessage = `
SUPPORT REQUEST

User: ${currentUser.fullName}
Email: ${currentUser.email}
Phone: ${currentUser.phone}
Subject: ${subject}

MESSAGE:
${message}

Request Time: ${new Date().toLocaleString()}
            `;
            
            const sent = await sendEmailNotification('Support Request - ' + subject, emailMessage, {
                user_name: currentUser.fullName,
                subject: subject,
                user_message: message
            });
            
            if (sent) {
                showToast('Support request submitted successfully!');
                document.getElementById('support-form').reset();
                setTimeout(() => showSection('dashboard'), 2000);
            } else {
                showToast('Failed to send support request. Please try again.', 'error');
            }
        });
        
        // Refund form
        document.getElementById('refund-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const type = document.getElementById('refund-type').value;
            const amount = document.getElementById('refund-amount').value;
            const transaction = document.getElementById('refund-transaction').value;
            const reason = document.getElementById('refund-reason').value;
            
            if (!currentUser) {
                showToast('Please login first', 'error');
                return;
            }
            
            const emailMessage = `
REFUND REQUEST

User: ${currentUser.fullName}
Email: ${currentUser.email}
Phone: ${currentUser.phone}
Refund Type: ${type}
Amount: Ksh ${amount}
Transaction Reference: ${transaction}

REASON:
${reason}

Request Time: ${new Date().toLocaleString()}

Please review and process this refund request.
            `;
            
            const sent = await sendEmailNotification('Refund Request - ' + type, emailMessage, {
                user_name: currentUser.fullName,
                refund_type: type,
                amount: `Ksh ${amount}`,
                transaction_ref: transaction,
                reason: reason
            });
            
            if (sent) {
                showToast('Refund request submitted successfully! We will review it shortly.');
                document.getElementById('refund-form').reset();
                setTimeout(() => showSection('dashboard'), 2000);
            } else {
                showToast('Failed to send refund request. Please try again.', 'error');
            }
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c744bf3b36cb281',t:'MTc2OTk3ODc3MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>